# Steps to implement CCAvenue with Node JS

## Flow of request and response

-Step 1: First, we hit the ccAvenueRequest URL.

-Step 2: The server returns an encrypted response.

-Step 3: With this encrypted response and access key provided by the CCAvenue, we make a request to the CCAvenue.

-Step 4: Payment page render

-Step 5: After the customer makes the payment, ccAvenue hits the response URL and sends an encrypted request.


# Code Setup

-First, we need to make a request handler and response handler controller function.

### Request handeler controller function

```
var http = require('http'),
    fs = require('fs'),
    ccav = require('./ccavutil.js'),
    crypto = require('crypto'),
    qs = require('querystring');


exports.postReq = function(request,response){

    var body = '',
	workingKey = 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXX',	//Put in the 32-Bit key shared by CCAvenues.
	accessCode = 'XXXXXXXXXXXXXXXXXXX',			//Put in the Access Code shared by CCAvenues.
	encRequest = '',
   
    //Generate Md5 hash for the key and then convert in base64 string
    var md5 = crypto.createHash('md5').update(workingKey).digest();
    var keyBase64 = Buffer.from(md5).toString('base64');

    //Initializing Vector and then convert in base64 string
    var ivBase64 = Buffer.from([0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d,0x0e, 0x0f]).toString('base64');

	body += requst.payment_string;
	encRequest = ccav.encrypt(body, keyBase64, ivBase64);
    
   return res.status(200); 
};

```


**Note:The request body should be exactly in this format**

```
    "payment_string":"merchant_id=XXXXX&order_id=0001&currency=INR&amount=6000.00&redirect_url=http:/ccavResponse&cancel_url=ccavResponse&language=EN"

```

And the mandatory fileds are

merchant_id(Numeric) : Merchant Id is a unique identifier generated by
CCAvenue for each activated merchant.

order_id(Alphanumeric) : This ID is used by merchants to identify the order.
Ensure that you send a unique id with each
request. CCAvenue will not check the uniqueness
of this order id. As it generates a unique payment
reference number for each order which is sent by
the merchant.


currency(Alphabet(3)) : Currency in which you want to process the
transaction.
INR – Indian Rupee
USD – United States Dollar
SGD – Singapore Dollar
GBP – Pound Sterling
EUR – Euro, official currency of Eurozone 

amount(Numeric) : Order amount

redirect_url(Alphanumeric) : CCAvenue will post the status of the order along
with the parameters to this URL. If you do not send
this value, order status will be sent back to the URL
configured in dynamic event notifications module
in your MARS account. If there is no URL
configured in the MARS account, PG will display the
status of the order on the CCAvenue confirmation
page.

cancel_url(Alphanumeric) :CCAvenue will redirect the customer to this URL if
the customer cancels the transaction on the billing
page. 

language(Alphabet(5)) : CCAvenue billing page is multi-lingual. Currently we
are displaying the page in English (Code - EN).


**If we need to pass some of our customized parameter the CCAvenue give us merchant_param1 to merchant_param5 we can send upto 5 custom param**


### Response handler

```
var http = require('http'),
    fs = require('fs'),
    ccav = require('./ccavutil.js'),
    crypto = require('crypto'),
    qs = require('querystring');

exports.postRes = function(request,response){
	ccavResponse='',	
	workingKey = 'XXXXXXXXXXXXXXXXXXXX',	//Put in the 32-Bit key shared by CCAvenues.

	
    //Generate Md5 hash for the key and then convert in base64 string
    var md5 = crypto.createHash('md5').update(workingKey).digest();
    var keyBase64 = Buffer.from(md5).toString('base64');

    //Initializing Vector and then convert in base64 string
    var ivBase64 = Buffer.from([0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d,0x0e, 0x0f]).toString('base64');
    
    ccavResponse = decrypt(request.body.encResp, keyBase64, ivBase64);

    // your logic here 

	
};

```

Structure of the dycrypt response by ccAvenue

```
{"order_id=1692702458009934_2711981&tracking_id=112980871927&bank_ref_no=XXXXXXXXXXXXXXXXX&order_status=Success&failure_message=&payment_mode=Wallet&card_name=Paytm&status_code=null&status_message=Txn Success&currency=INR&amount=1.00&billing_name=Customer Name&billing_address=Everest house&billing_city=Kolkata&billing_state=West Bengal&billing_zip=700085&billing_country=India&billing_tel=8017156043&billing_email=customer@gmail.com&delivery_name=customer_name&delivery_address=Everest house&delivery_city=Kolkata&delivery_state=West Bengal&delivery_zip=700085&delivery_country=India&delivery_tel=8017156043&merchant_param1=&merchant_param2=&merchant_param3=&merchant_param4=&merchant_param5=&vault=N&offer_type=null&offer_code=null&discount_value=0.0&mer_amount=1.00&eci_value=null&retry=N&response_code=0&billing_notes=&trans_date=22/08/2023 16:38:33&bin_country="}

```

### Util function

-For getting Algorithm

```
function getAlgorithm(keyBase64) {
    var key = Buffer.from(keyBase64, 'base64');
    switch (key.length) {
        case 16:
            return 'aes-128-cbc';
        case 32:
            return 'aes-256-cbc';

    }
    throw new Error('Invalid key length: ' + key.length);
}


```


-For encryption

```
    exports.encrypt = function(plainText, keyBase64, ivBase64) {

    const key = Buffer.from(keyBase64, 'base64');
    const iv = Buffer.from(ivBase64, 'base64');

    const cipher = crypto.createCipheriv(getAlgorithm(keyBase64), key, iv);
    let encrypted = cipher.update(plainText, 'utf8', 'hex')
    encrypted += cipher.final('hex');
    return encrypted;
}

```

-For dycryption

```
exports.decrypt = function(messagebase64, keyBase64, ivBase64) {

    const key = Buffer.from(keyBase64, 'base64');
    const iv = Buffer.from(ivBase64, 'base64');

    const decipher = crypto.createDecipheriv(getAlgorithm(keyBase64), key, iv);
    let decrypted = decipher.update(messagebase64, 'hex');
    decrypted += decipher.final();
    return decrypted;
}

```


## Possible error you might face

- The payment page might not render ERROR 1002 :

**The access code , merchant id or the working key is worng**
OR
**The link you are making request from is not whitelisted and to whitelist you need to mail it to CCAvenue**
